name: Destroy PR Preview Deployments

on:
  pull_request:
    types: [closed]
  workflow_dispatch:
    inputs:
      pr_number:
        description: PR number to clean up (e.g. 154)
        required: true
        type: string
      actually_delete:
        description: Actually delete resources (dangerous)
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: pr-preview-destroy-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  destroy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    name: Destroy
    env:
      CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_KEY }}
      PR_NUMBER: ${{ github.event.inputs.pr_number || github.event.pull_request.number }}
      ACTUALLY_DELETE: ${{ github.event.inputs.actually_delete || 'false' }}
    steps:
      - name: Compute preview identifiers
        run: |
          echo "PR_BRANCH=pr-$PR_NUMBER" >> "$GITHUB_ENV"
          echo "WORKER_NAME=douren-backend-pr-$PR_NUMBER" >> "$GITHUB_ENV"

      - name: Summary
        run: |
          {
            echo "## Preview cleanup"
            echo ""
            echo "- PR: \`$PR_NUMBER\`"
            echo "- Pages branch: \`$PR_BRANCH\`"
            echo "- Backend Worker: \`$WORKER_NAME\`"
            echo "- Mode: \`$([[ \"$ACTUALLY_DELETE\" == \"true\" || \"${{ github.event_name }}\" == \"pull_request\" ]] && echo delete || echo dry-run)\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Delete Pages deployments for branch
        if: github.event_name == 'pull_request' || github.event.inputs.actually_delete == 'true'
        env:
          PR_BRANCH: ${{ env.PR_BRANCH }}
        run: |
          set -euo pipefail

          delete_pages_branch_deployments() {
            local project="$1"
            echo "Deleting Pages deployments for project=$project branch=$PR_BRANCH"

            local resp
            resp="$(curl -sS \
              -H "Authorization: Bearer $CF_API_TOKEN" \
              -H "Content-Type: application/json" \
              "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT_ID/pages/projects/$project/deployments?branch=$PR_BRANCH&per_page=100")"

            local ids
            ids="$(node -e '
              const fs = require("fs");
              const o = JSON.parse(fs.readFileSync(0,"utf8"));
              if (!o?.success) process.exit(2);
              const ids = (o?.result ?? []).map((d) => d?.id).filter(Boolean);
              process.stdout.write(ids.join("\n"));
            ' <<< "$resp" || true)"

            if [[ -z "${ids:-}" ]]; then
              echo "No deployments found for $project/$PR_BRANCH (OK)"
              return 0
            fi

            while IFS= read -r id; do
              [[ -z "$id" ]] && continue
              echo "Deleting deployment id=$id"
              curl -sS -X DELETE \
                -H "Authorization: Bearer $CF_API_TOKEN" \
                -H "Content-Type: application/json" \
                "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT_ID/pages/projects/$project/deployments/$id" \
                > /dev/null
            done <<< "$ids"
          }

          delete_pages_branch_deployments "douren-frontend"
          delete_pages_branch_deployments "douren-cms"

      - name: Delete backend Worker script
        if: github.event_name == 'pull_request' || github.event.inputs.actually_delete == 'true'
        env:
          WORKER_NAME: ${{ env.WORKER_NAME }}
        run: |
          set -euo pipefail
          echo "Deleting Worker script name=$WORKER_NAME"
          curl -sS -X DELETE \
            -H "Authorization: Bearer $CF_API_TOKEN" \
            -H "Content-Type: application/json" \
            "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT_ID/workers/scripts/$WORKER_NAME" \
            > /dev/null || true

      - name: Comment PR with destroy result
        uses: actions/github-script@v7
        env:
          PR_BRANCH: ${{ env.PR_BRANCH }}
          WORKER_NAME: ${{ env.WORKER_NAME }}
        with:
          script: |
            const marker = "<!-- douren-preview-destroy -->";
            const body =
              `${marker}\nPR preview cleanup completed.\n` +
              `- Pages branch: ${process.env.PR_BRANCH}\n` +
              `- Backend Worker: ${process.env.WORKER_NAME}\n`;

            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body,
            });
